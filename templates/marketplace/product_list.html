{% extends 'base.html' %}
{% block title %}Marketplace | LagosWebDev{% endblock %}

{% block content %}
<div class="mp-wrap">

  <!-- HERO -->
  <section class="mp-hero">
    <div class="container position-relative">
      <div class="row justify-content-center text-center">
        <div class="col-lg-9">
          <h1 class="mp-title">
            <i class="fas fa-store me-3"></i>Marketplace
          </h1>
          <p class="mp-sub">
            Premium templates, scripts, and tools — ready to launch your next project.
          </p>

          <!-- Search + Filter -->
          <div class="mp-search">
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-search"></i></span>
              <input type="text" class="form-control" id="searchInput" placeholder="Search products...">

              <select class="form-select" id="categoryFilter">
                <option value="">All Categories</option>
                {# Use YOUR Product CATEGORY_CHOICES #}
                <option value="script">Script</option>
                <option value="tool">Tool</option>
                <option value="plugin">Plugin</option>
                <option value="template">Template</option>
              </select>
            </div>

            <div class="mp-mini mt-3">
              <div class="mini-pill"><i class="fas fa-bolt"></i>Instant delivery</div>
              <div class="mini-pill"><i class="fas fa-shield-alt"></i>Secure checkout</div>
              <div class="mini-pill"><i class="fas fa-headset"></i>Support</div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </section>

  <!-- LIST HEADER -->
  <section class="py-4">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div>
          <h2 class="mb-1"><i class="fas fa-th-large me-2"></i>Browse Products</h2>
          <p class="mb-0" style="color: var(--netflix-light-gray);">
            Showing <span id="productCount">{{ products.count }}</span> product(s)
          </p>
        </div>

        <div class="mp-view">
          <button class="btn btn-sm btn-outline-light active" id="gridView" type="button" title="Grid view">
            <i class="fas fa-th"></i>
          </button>
          <button class="btn btn-sm btn-outline-light" id="listView" type="button" title="List view">
            <i class="fas fa-list"></i>
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- PRODUCTS -->
  <section class="pb-5">
    <div class="container">

      <div class="mp-grid row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="productsGrid">
        {% for product in products %}
        <div class="col product-item" data-category="{{ product.category|lower }}">
          <div class="mp-card h-100">

            <!-- Image -->
            <a class="mp-img" href="{% url 'marketplace:product_detail' product.slug %}">
              {% if product.main_image %}
                <img src="{{ product.main_image.url }}" alt="{{ product.title }}">
              {% else %}
                <div class="mp-ph"><i class="fas fa-laptop-code"></i></div>
              {% endif %}

              <div class="mp-badges">
                {% if product.is_featured %}
                  <span class="badge bg-danger"><i class="fas fa-star me-1"></i>Featured</span>
                {% endif %}
                {% if product.version %}
                  <span class="badge bg-dark">v{{ product.version }}</span>
                {% endif %}
              </div>
            </a>

            <!-- Content -->
            <div class="mp-body">
              <div class="mp-cat">
                <span class="cat-pill"><i class="fas fa-tag me-1"></i>{{ product.get_category_display }}</span>
              </div>

              <h5 class="mp-name">
                <a href="{% url 'marketplace:product_detail' product.slug %}">{{ product.title }}</a>
              </h5>

              {% if product.short_description %}
                <p class="mp-desc">{{ product.short_description|truncatewords:18 }}</p>
              {% elif product.description %}
                <p class="mp-desc">{{ product.description|striptags|truncatewords:18 }}</p>
              {% endif %}

              {% if product.tech_stack %}
                <div class="mp-tech">
                  <i class="fas fa-layer-group me-2"></i>{{ product.tech_stack }}
                </div>
              {% endif %}

              <div class="mp-footer">
                <div class="mp-price">
                  <div class="price-label">From</div>
                  <div class="price-value">₦{{ product.price_full_ownership|floatformat:0 }}</div>
                </div>

                <a href="{% url 'marketplace:product_detail' product.slug %}" class="btn btn-netflix-primary btn-sm">
                  View<i class="fas fa-arrow-right ms-2"></i>
                </a>
              </div>
            </div>

          </div>
        </div>
        {% empty %}
        <div class="col-12">
          <div class="mp-empty text-center py-5">
            <i class="fas fa-box-open fa-4x mb-3" style="opacity:.5;"></i>
            <h3 class="mb-2">No products yet</h3>
            <p class="mb-4" style="color: var(--netflix-light-gray);">
              We’re adding new items soon. Want something custom?
            </p>
            <a href="{% url 'contact:contact_page' %}" class="btn btn-netflix-primary">
              <i class="fas fa-envelope me-2"></i>Request a Custom Product
            </a>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- No results -->
      <div class="row d-none" id="noResults">
        <div class="col-12">
          <div class="mp-empty text-center py-5">
            <i class="fas fa-search fa-4x mb-3" style="opacity:.5;"></i>
            <h3 class="mb-2">No products found</h3>
            <p class="mb-4" style="color: var(--netflix-light-gray);">
              Try a different search or category.
            </p>
            <button class="btn btn-netflix-secondary" id="clearFilters" type="button">
              <i class="fas fa-redo me-2"></i>Clear Filters
            </button>
          </div>
        </div>
      </div>

    </div>
  </section>

  <!-- CTA -->
  <section class="py-5">
    <div class="container">
      <div class="netflix-card text-center p-5 mp-cta">
        <h2 class="mb-2">Need something custom?</h2>
        <p class="lead mb-4">We can build it exactly to your requirements.</p>
        <div class="d-flex justify-content-center gap-3 flex-wrap">
          <a href="{% url 'contact:contact_page' %}" class="btn btn-netflix-secondary btn-lg">
            <i class="fas fa-comments me-2"></i>Request Custom Project
          </a>
          <a href="{% url 'pricing:pricing_page' %}" class="btn btn-light btn-lg">
            <i class="fas fa-tag me-2"></i>View Pricing
          </a>
        </div>
      </div>
    </div>
  </section>

</div>

<style>
  .mp-wrap{ padding-top:80px; min-height:100vh; }

  .mp-hero{
    position:relative;
    padding: 5.5rem 0 3.5rem;
    background: linear-gradient(135deg, rgba(229,9,20,0.12), rgba(20,20,20,0.92));
    border-bottom: 1px solid var(--netflix-medium-gray);
  }
  .mp-title{
    font-size: clamp(2.2rem, 4vw, 3.4rem);
    font-weight: 950;
    margin-bottom: .6rem;
  }
  .mp-sub{
    color: var(--netflix-light-gray);
    font-size: 1.1rem;
    margin-bottom: 1.6rem;
  }

  .mp-search{ max-width: 820px; margin: 0 auto; }
  .mp-search .input-group{
    overflow:hidden;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,0.08);
    box-shadow: 0 12px 45px rgba(0,0,0,.35);
  }
  .mp-search .input-group-text,
  .mp-search .form-control,
  .mp-search .form-select{
    background: rgba(0,0,0,0.35);
    border: 0;
    color: var(--netflix-white);
    padding: 1rem 1rem;
  }
  .mp-search .form-control::placeholder{ color: var(--netflix-light-gray); }
  .mp-search .form-control:focus,
  .mp-search .form-select:focus{ box-shadow:none; outline:none; background: rgba(255,255,255,0.06); }

  .mp-mini{ display:flex; gap:.75rem; justify-content:center; flex-wrap:wrap; }
  .mini-pill{
    display:inline-flex; align-items:center; gap:.5rem;
    padding: .45rem .8rem;
    border-radius: 999px;
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--netflix-medium-gray);
    color: var(--netflix-light-gray);
    font-size: .9rem;
  }
  .mini-pill i{ color: #28a745; }

  .mp-view button{
    border-color: var(--netflix-medium-gray);
    color: var(--netflix-light-gray);
  }
  .mp-view button.active,
  .mp-view button:hover{
    background: var(--netflix-red);
    border-color: var(--netflix-red);
    color: var(--netflix-white);
  }

  /* Card */
  .mp-card{
    border-radius: 16px;
    overflow:hidden;
    background: rgba(255,255,255,0.03);
    border: 1px solid var(--netflix-medium-gray);
    transition: transform .2s ease, border-color .2s ease;
    display:flex;
    flex-direction:column;
  }
  .mp-card:hover{ transform: translateY(-4px); border-color: rgba(229,9,20,0.35); }

  .mp-img{
    position:relative;
    display:block;
    height: 220px;
    background: var(--netflix-dark-gray);
    overflow:hidden;
    text-decoration:none;
  }
  .mp-img img{
    width:100%; height:100%;
    object-fit:cover;
    transition: transform .45s ease;
  }
  .mp-card:hover .mp-img img{ transform: scale(1.06); }

  .mp-ph{
    height:100%;
    display:flex; align-items:center; justify-content:center;
    color: var(--netflix-light-gray);
    background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(0,0,0,0.25));
    font-size: 2.8rem;
  }

  .mp-badges{
    position:absolute;
    top:12px; left:12px;
    display:flex; flex-direction:column; gap:.45rem;
  }

  .mp-body{ padding: 1.25rem; display:flex; flex-direction:column; gap:.6rem; flex:1; }

  .cat-pill{
    display:inline-flex; align-items:center;
    font-size: .78rem;
    color: var(--netflix-red);
    background: rgba(229,9,20,0.12);
    border: 1px solid rgba(229,9,20,0.22);
    padding: .28rem .7rem;
    border-radius: 999px;
    font-weight: 800;
    letter-spacing: .5px;
    text-transform: uppercase;
  }

  .mp-name{ margin:0; font-weight: 900; }
  .mp-name a{ color: var(--netflix-white); text-decoration:none; }
  .mp-name a:hover{ color: var(--netflix-red); }

  .mp-desc{
    margin:0;
    color: var(--netflix-light-gray);
    line-height:1.55;
    font-size: .95rem;
  }

  .mp-tech{
    color: var(--netflix-light-gray);
    font-size: .9rem;
    opacity: .95;
  }

  .mp-footer{
    margin-top:auto;
    padding-top: 1rem;
    border-top: 1px solid var(--netflix-medium-gray);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 1rem;
  }

  .mp-price .price-label{
    font-size: .75rem;
    color: var(--netflix-light-gray);
    text-transform: uppercase;
    letter-spacing: .6px;
  }
  .mp-price .price-value{
    font-size: 1.45rem;
    font-weight: 950;
    color: var(--netflix-red);
    line-height: 1.1;
  }

  .mp-empty{
    background: rgba(255,255,255,0.03);
    border: 1px solid var(--netflix-medium-gray);
    border-radius: 16px;
    padding: 3rem 2rem;
  }

  .mp-cta{
    background: linear-gradient(135deg, var(--netflix-red), #b20710);
    border: none;
  }

  /* LIST VIEW */
  .mp-grid.list-view{
    display:flex;
    flex-direction:column;
    gap: 1rem;
  }
  .mp-grid.list-view .product-item{ width:100%; }
  .mp-grid.list-view .mp-card{
    flex-direction:row;
    align-items:stretch;
  }
  .mp-grid.list-view .mp-img{
    width: 280px;
    height: 180px;
    flex-shrink:0;
    border-right: 1px solid var(--netflix-medium-gray);
  }

  @media (max-width: 768px){
    .mp-wrap{ padding-top:70px; }
    .mp-grid.list-view .mp-card{ flex-direction:column; }
    .mp-grid.list-view .mp-img{ width:100%; height: 210px; border-right:none; }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('searchInput');
    const categoryFilter = document.getElementById('categoryFilter');
    const productsGrid = document.getElementById('productsGrid');
    const productItems = document.querySelectorAll('.product-item');
    const productCount = document.getElementById('productCount');
    const noResults = document.getElementById('noResults');
    const clearFiltersBtn = document.getElementById('clearFilters');
    const gridViewBtn = document.getElementById('gridView');
    const listViewBtn = document.getElementById('listView');

    function filterProducts() {
      const searchTerm = (searchInput?.value || '').toLowerCase().trim();
      const selectedCategory = (categoryFilter?.value || '').toLowerCase().trim();
      let visibleCount = 0;

      productItems.forEach(item => {
        const title = item.querySelector('.mp-name a')?.textContent.toLowerCase() || '';
        const desc = item.querySelector('.mp-desc')?.textContent.toLowerCase() || '';
        const cat = item.dataset.category || '';

        const matchesSearch = !searchTerm || title.includes(searchTerm) || desc.includes(searchTerm);
        const matchesCategory = !selectedCategory || cat === selectedCategory;

        if (matchesSearch && matchesCategory) {
          item.style.display = '';
          visibleCount++;
        } else {
          item.style.display = 'none';
        }
      });

      if (productCount) productCount.textContent = visibleCount;

      if (visibleCount === 0) {
        productsGrid.classList.add('d-none');
        noResults.classList.remove('d-none');
      } else {
        productsGrid.classList.remove('d-none');
        noResults.classList.add('d-none');
      }
    }

    searchInput?.addEventListener('input', filterProducts);
    categoryFilter?.addEventListener('change', filterProducts);

    clearFiltersBtn?.addEventListener('click', function () {
      if (searchInput) searchInput.value = '';
      if (categoryFilter) categoryFilter.value = '';
      filterProducts();
    });

    gridViewBtn?.addEventListener('click', function () {
      productsGrid.classList.remove('list-view');
      productsGrid.classList.add('row', 'row-cols-1', 'row-cols-md-2', 'row-cols-lg-3', 'g-4');
      gridViewBtn.classList.add('active');
      listViewBtn.classList.remove('active');
    });

    listViewBtn?.addEventListener('click', function () {
      productsGrid.classList.add('list-view');
      productsGrid.classList.remove('row-cols-1', 'row-cols-md-2', 'row-cols-lg-3', 'g-4');
      listViewBtn.classList.add('active');
      gridViewBtn.classList.remove('active');
    });
  });
</script>
{% endblock %}
